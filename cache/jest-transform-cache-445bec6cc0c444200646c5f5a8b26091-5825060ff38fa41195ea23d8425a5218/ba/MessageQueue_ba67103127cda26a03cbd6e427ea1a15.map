{"version":3,"names":["Systrace","require","deepFreezeAndThrowOnMutationInDev","stringifySafe","warnOnce","ErrorUtils","invariant","TO_JS","TO_NATIVE","MODULE_IDS","METHOD_IDS","PARAMS","MIN_TIME_BETWEEN_FLUSHES_MS","TRACE_TAG_REACT_APPS","DEBUG_INFO_LIMIT","MessageQueue","_lazyCallableModules","_queue","_successCallbacks","_failureCallbacks","_callID","_lastFlush","_eventLoopStartTime","_reactNativeMicrotasksCallback","_debugInfo","_remoteModuleTable","_remoteMethodTable","__spy","Map","Date","now","__DEV__","callFunctionReturnFlushedQueue","bind","flushedQueue","invokeCallbackAndReturnFlushedQueue","module","method","args","__guard","__callFunction","cbID","__invokeCallback","__callReactNativeMicrotasks","queue","length","name","factory","getValue","moduleID","methodID","params","onFail","onSucc","global","nativeCallSyncHook","processCallbacks","size","info","forEach","_","callID","debug","push","set","nativeTraceBeginAsyncFlow","isValidArgument","val","isFinite","Array","isArray","every","k","replacer","key","t","toString","JSON","stringify","nativeFlushQueueImmediate","counterEvent","type","methods","fn","__shouldPauseOnThrow","error","reportFatalError","DebuggerInternal","shouldPauseOnThrow","beginEvent","endEvent","moduleMethods","getCallableModule","callableModuleNames","Object","keys","n","callableModuleNameList","join","apply","isSuccess","callback","get","profileName","spyOrToggle","prototype","console","log","exports"],"sources":["MessageQueue.js"],"sourcesContent":["/**\n * Copyright (c) Meta Platforms, Inc. and affiliates.\n *\n * This source code is licensed under the MIT license found in the\n * LICENSE file in the root directory of this source tree.\n *\n * @flow strict\n * @format\n */\n\n'use strict';\n\nconst Systrace = require('../Performance/Systrace');\nconst deepFreezeAndThrowOnMutationInDev = require('../Utilities/deepFreezeAndThrowOnMutationInDev');\nconst stringifySafe = require('../Utilities/stringifySafe').default;\nconst warnOnce = require('../Utilities/warnOnce');\nconst ErrorUtils = require('../vendor/core/ErrorUtils');\nconst invariant = require('invariant');\n\nexport type SpyData = {\n  type: number,\n  module: ?string,\n  method: string | number,\n  args: mixed[],\n  ...\n};\n\nconst TO_JS = 0;\nconst TO_NATIVE = 1;\n\nconst MODULE_IDS = 0;\nconst METHOD_IDS = 1;\nconst PARAMS = 2;\nconst MIN_TIME_BETWEEN_FLUSHES_MS = 5;\n\n// eslint-disable-next-line no-bitwise\nconst TRACE_TAG_REACT_APPS = 1 << 17;\n\nconst DEBUG_INFO_LIMIT = 32;\n\nclass MessageQueue {\n  _lazyCallableModules: {[key: string]: (void) => {...}, ...};\n  _queue: [number[], number[], mixed[], number];\n  _successCallbacks: Map<number, ?(...mixed[]) => void>;\n  _failureCallbacks: Map<number, ?(...mixed[]) => void>;\n  _callID: number;\n  _lastFlush: number;\n  _eventLoopStartTime: number;\n  _reactNativeMicrotasksCallback: ?() => void;\n\n  _debugInfo: {[number]: [number, number], ...};\n  _remoteModuleTable: {[number]: string, ...};\n  _remoteMethodTable: {[number]: $ReadOnlyArray<string>, ...};\n\n  __spy: ?(data: SpyData) => void;\n\n  constructor() {\n    this._lazyCallableModules = {};\n    this._queue = [[], [], [], 0];\n    this._successCallbacks = new Map();\n    this._failureCallbacks = new Map();\n    this._callID = 0;\n    this._lastFlush = 0;\n    this._eventLoopStartTime = Date.now();\n    this._reactNativeMicrotasksCallback = null;\n\n    if (__DEV__) {\n      this._debugInfo = {};\n      this._remoteModuleTable = {};\n      this._remoteMethodTable = {};\n    }\n\n    // $FlowFixMe[cannot-write]\n    this.callFunctionReturnFlushedQueue =\n      // $FlowFixMe[method-unbinding] added when improving typing for this parameters\n      this.callFunctionReturnFlushedQueue.bind(this);\n    // $FlowFixMe[cannot-write]\n    // $FlowFixMe[method-unbinding] added when improving typing for this parameters\n    this.flushedQueue = this.flushedQueue.bind(this);\n\n    // $FlowFixMe[cannot-write]\n    this.invokeCallbackAndReturnFlushedQueue =\n      // $FlowFixMe[method-unbinding] added when improving typing for this parameters\n      this.invokeCallbackAndReturnFlushedQueue.bind(this);\n  }\n\n  /**\n   * Public APIs\n   */\n\n  static spy(spyOrToggle: boolean | ((data: SpyData) => void)) {\n    if (spyOrToggle === true) {\n      MessageQueue.prototype.__spy = info => {\n        console.log(\n          `${info.type === TO_JS ? 'N->JS' : 'JS->N'} : ` +\n            `${info.module != null ? info.module + '.' : ''}${info.method}` +\n            `(${JSON.stringify(info.args)})`,\n        );\n      };\n    } else if (spyOrToggle === false) {\n      MessageQueue.prototype.__spy = null;\n    } else {\n      MessageQueue.prototype.__spy = spyOrToggle;\n    }\n  }\n\n  callFunctionReturnFlushedQueue(\n    module: string,\n    method: string,\n    args: mixed[],\n  ): null | [Array<number>, Array<number>, Array<mixed>, number] {\n    this.__guard(() => {\n      this.__callFunction(module, method, args);\n    });\n\n    return this.flushedQueue();\n  }\n\n  invokeCallbackAndReturnFlushedQueue(\n    cbID: number,\n    args: mixed[],\n  ): null | [Array<number>, Array<number>, Array<mixed>, number] {\n    this.__guard(() => {\n      this.__invokeCallback(cbID, args);\n    });\n\n    return this.flushedQueue();\n  }\n\n  flushedQueue(): null | [Array<number>, Array<number>, Array<mixed>, number] {\n    this.__guard(() => {\n      this.__callReactNativeMicrotasks();\n    });\n\n    const queue = this._queue;\n    this._queue = [[], [], [], this._callID];\n    return queue[0].length ? queue : null;\n  }\n\n  getEventLoopRunningTime(): number {\n    return Date.now() - this._eventLoopStartTime;\n  }\n\n  registerCallableModule(name: string, module: {...}) {\n    this._lazyCallableModules[name] = () => module;\n  }\n\n  registerLazyCallableModule(name: string, factory: void => interface {}) {\n    let module: interface {};\n    let getValue: ?(void) => interface {} = factory;\n    this._lazyCallableModules[name] = () => {\n      if (getValue) {\n        module = getValue();\n        getValue = null;\n      }\n      /* $FlowFixMe[class-object-subtyping] added when improving typing for\n       * this parameters */\n      return module;\n    };\n  }\n\n  getCallableModule(name: string): {...} | null {\n    const getValue = this._lazyCallableModules[name];\n    return getValue ? getValue() : null;\n  }\n\n  callNativeSyncHook(\n    moduleID: number,\n    methodID: number,\n    params: mixed[],\n    onFail: ?(...mixed[]) => void,\n    onSucc: ?(...mixed[]) => void,\n  ): mixed {\n    if (__DEV__) {\n      invariant(\n        global.nativeCallSyncHook,\n        'Calling synchronous methods on native ' +\n          'modules is not supported in Chrome.\\n\\n Consider providing alternative ' +\n          'methods to expose this method in debug mode, e.g. by exposing constants ' +\n          'ahead-of-time.',\n      );\n    }\n    this.processCallbacks(moduleID, methodID, params, onFail, onSucc);\n    return global.nativeCallSyncHook(moduleID, methodID, params);\n  }\n\n  processCallbacks(\n    moduleID: number,\n    methodID: number,\n    params: mixed[],\n    onFail: ?(...mixed[]) => void,\n    onSucc: ?(...mixed[]) => void,\n  ): void {\n    if (onFail || onSucc) {\n      if (__DEV__) {\n        this._debugInfo[this._callID] = [moduleID, methodID];\n        if (this._callID > DEBUG_INFO_LIMIT) {\n          delete this._debugInfo[this._callID - DEBUG_INFO_LIMIT];\n        }\n        if (this._successCallbacks.size > 500) {\n          const info: {[number]: {method: string, module: string}} = {};\n          this._successCallbacks.forEach((_, callID) => {\n            const debug = this._debugInfo[callID];\n            const module = debug && this._remoteModuleTable[debug[0]];\n            const method = debug && this._remoteMethodTable[debug[0]][debug[1]];\n            info[callID] = {module, method};\n          });\n          warnOnce(\n            'excessive-number-of-pending-callbacks',\n            `Please report: Excessive number of pending callbacks: ${\n              this._successCallbacks.size\n            }. Some pending callbacks that might have leaked by never being called from native code: ${stringifySafe(\n              info,\n            )}`,\n          );\n        }\n      }\n      // Encode callIDs into pairs of callback identifiers by shifting left and using the rightmost bit\n      // to indicate fail (0) or success (1)\n      // eslint-disable-next-line no-bitwise\n      onFail && params.push(this._callID << 1);\n      // eslint-disable-next-line no-bitwise\n      onSucc && params.push((this._callID << 1) | 1);\n      this._successCallbacks.set(this._callID, onSucc);\n      this._failureCallbacks.set(this._callID, onFail);\n    }\n    if (__DEV__) {\n      global.nativeTraceBeginAsyncFlow &&\n        global.nativeTraceBeginAsyncFlow(\n          TRACE_TAG_REACT_APPS,\n          'native',\n          this._callID,\n        );\n    }\n    this._callID++;\n  }\n\n  enqueueNativeCall(\n    moduleID: number,\n    methodID: number,\n    params: mixed[],\n    onFail: ?(...mixed[]) => void,\n    onSucc: ?(...mixed[]) => void,\n  ) {\n    this.processCallbacks(moduleID, methodID, params, onFail, onSucc);\n\n    this._queue[MODULE_IDS].push(moduleID);\n    this._queue[METHOD_IDS].push(methodID);\n\n    if (__DEV__) {\n      // Validate that parameters passed over the bridge are\n      // folly-convertible.  As a special case, if a prop value is a\n      // function it is permitted here, and special-cased in the\n      // conversion.\n      const isValidArgument = (val: mixed) => {\n        switch (typeof val) {\n          case 'undefined':\n          case 'boolean':\n          case 'string':\n            return true;\n          case 'number':\n            return isFinite(val);\n          case 'object':\n            if (val == null) {\n              return true;\n            }\n\n            if (Array.isArray(val)) {\n              return val.every(isValidArgument);\n            }\n\n            for (const k in val) {\n              if (typeof val[k] !== 'function' && !isValidArgument(val[k])) {\n                return false;\n              }\n            }\n\n            return true;\n          case 'function':\n            return false;\n          default:\n            return false;\n        }\n      };\n\n      // Replacement allows normally non-JSON-convertible values to be\n      // seen.  There is ambiguity with string values, but in context,\n      // it should at least be a strong hint.\n      const replacer = (key: string, val: $FlowFixMe) => {\n        const t = typeof val;\n        if (t === 'function') {\n          return '<<Function ' + val.name + '>>';\n        } else if (t === 'number' && !isFinite(val)) {\n          return '<<' + val.toString() + '>>';\n        } else {\n          return val;\n        }\n      };\n\n      // Note that JSON.stringify\n      invariant(\n        isValidArgument(params),\n        '%s is not usable as a native method argument',\n        JSON.stringify(params, replacer),\n      );\n\n      // The params object should not be mutated after being queued\n      deepFreezeAndThrowOnMutationInDev(params);\n    }\n    this._queue[PARAMS].push(params);\n\n    const now = Date.now();\n    if (\n      global.nativeFlushQueueImmediate &&\n      now - this._lastFlush >= MIN_TIME_BETWEEN_FLUSHES_MS\n    ) {\n      const queue = this._queue;\n      this._queue = [[], [], [], this._callID];\n      this._lastFlush = now;\n      global.nativeFlushQueueImmediate(queue);\n    }\n    Systrace.counterEvent('pending_js_to_native_queue', this._queue[0].length);\n    if (__DEV__ && this.__spy && isFinite(moduleID)) {\n      this.__spy({\n        type: TO_NATIVE,\n        module: this._remoteModuleTable[moduleID],\n        method: this._remoteMethodTable[moduleID][methodID],\n        args: params,\n      });\n    } else if (this.__spy) {\n      this.__spy({\n        type: TO_NATIVE,\n        module: moduleID + '',\n        method: methodID,\n        args: params,\n      });\n    }\n  }\n\n  createDebugLookup(\n    moduleID: number,\n    name: string,\n    methods: ?$ReadOnlyArray<string>,\n  ) {\n    if (__DEV__) {\n      this._remoteModuleTable[moduleID] = name;\n      this._remoteMethodTable[moduleID] = methods || [];\n    }\n  }\n\n  // For JSTimers to register its callback. Otherwise a circular dependency\n  // between modules is introduced. Note that only one callback may be\n  // registered at a time.\n  setReactNativeMicrotasksCallback(fn: () => void) {\n    this._reactNativeMicrotasksCallback = fn;\n  }\n\n  /**\n   * Private methods\n   */\n\n  __guard(fn: () => void) {\n    if (this.__shouldPauseOnThrow()) {\n      fn();\n    } else {\n      try {\n        fn();\n      } catch (error) {\n        ErrorUtils.reportFatalError(error);\n      }\n    }\n  }\n\n  // MessageQueue installs a global handler to catch all exceptions where JS users can register their own behavior\n  // This handler makes all exceptions to be propagated from inside MessageQueue rather than by the VM at their origin\n  // This makes stacktraces to be placed at MessageQueue rather than at where they were launched\n  // The parameter DebuggerInternal.shouldPauseOnThrow is used to check before catching all exceptions and\n  // can be configured by the VM or any Inspector\n  __shouldPauseOnThrow(): boolean {\n    return (\n      // $FlowFixMe[cannot-resolve-name]\n      typeof DebuggerInternal !== 'undefined' &&\n      DebuggerInternal.shouldPauseOnThrow === true // eslint-disable-line no-undef\n    );\n  }\n\n  __callReactNativeMicrotasks() {\n    Systrace.beginEvent('JSTimers.callReactNativeMicrotasks()');\n    if (this._reactNativeMicrotasksCallback != null) {\n      this._reactNativeMicrotasksCallback();\n    }\n    Systrace.endEvent();\n  }\n\n  __callFunction(module: string, method: string, args: mixed[]): void {\n    this._lastFlush = Date.now();\n    this._eventLoopStartTime = this._lastFlush;\n    if (__DEV__ || this.__spy) {\n      Systrace.beginEvent(`${module}.${method}(${stringifySafe(args)})`);\n    } else {\n      Systrace.beginEvent(`${module}.${method}(...)`);\n    }\n    if (this.__spy) {\n      this.__spy({type: TO_JS, module, method, args});\n    }\n    const moduleMethods = this.getCallableModule(module);\n    if (!moduleMethods) {\n      const callableModuleNames = Object.keys(this._lazyCallableModules);\n      const n = callableModuleNames.length;\n      const callableModuleNameList = callableModuleNames.join(', ');\n      invariant(\n        false,\n        `Failed to call into JavaScript module method ${module}.${method}(). Module has not been registered as callable. Registered callable JavaScript modules (n = ${n}): ${callableModuleNameList}.\n        A frequent cause of the error is that the application entry file path is incorrect. This can also happen when the JS bundle is corrupt or there is an early initialization error when loading React Native.`,\n      );\n    }\n    if (!moduleMethods[method]) {\n      invariant(\n        false,\n        `Failed to call into JavaScript module method ${module}.${method}(). Module exists, but the method is undefined.`,\n      );\n    }\n    moduleMethods[method].apply(moduleMethods, args);\n    Systrace.endEvent();\n  }\n\n  __invokeCallback(cbID: number, args: mixed[]) {\n    this._lastFlush = Date.now();\n    this._eventLoopStartTime = this._lastFlush;\n\n    // The rightmost bit of cbID indicates fail (0) or success (1), the other bits are the callID shifted left.\n    // eslint-disable-next-line no-bitwise\n    const callID = cbID >>> 1;\n    // eslint-disable-next-line no-bitwise\n    const isSuccess = cbID & 1;\n    const callback = isSuccess\n      ? this._successCallbacks.get(callID)\n      : this._failureCallbacks.get(callID);\n\n    if (__DEV__) {\n      const debug = this._debugInfo[callID];\n      const module = debug && this._remoteModuleTable[debug[0]];\n      const method = debug && this._remoteMethodTable[debug[0]][debug[1]];\n      invariant(\n        callback,\n        `No callback found with cbID ${cbID} and callID ${callID} for ` +\n          (method\n            ? ` ${module}.${method} - most likely the callback was already invoked`\n            : `module ${module || '<unknown>'}`) +\n          `. Args: '${stringifySafe(args)}'`,\n      );\n      const profileName = debug\n        ? '<callback for ' + module + '.' + method + '>'\n        : cbID;\n      if (callback && this.__spy) {\n        this.__spy({type: TO_JS, module: null, method: profileName, args});\n      }\n      Systrace.beginEvent(\n        `MessageQueue.invokeCallback(${profileName}, ${stringifySafe(args)})`,\n      );\n    }\n\n    if (!callback) {\n      return;\n    }\n\n    this._successCallbacks.delete(callID);\n    this._failureCallbacks.delete(callID);\n    callback(...args);\n\n    if (__DEV__) {\n      Systrace.endEvent();\n    }\n  }\n}\n\nmodule.exports = MessageQueue;\n"],"mappings":"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"}